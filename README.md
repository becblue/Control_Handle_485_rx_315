# Modbus RTU主从通信系统

## 项目概述
本项目是一个基于STM32F103C8T6的Modbus RTU通讯系统的A站开发项目。该系统基于STM32F103C8T6主从架构的Modbus RTU通信系统，主站（A站）与从站（B站）通过RS485总线连接，主站集成按键输入、模拟量采集模块及LED指示灯，周期性采集数据并通过功能码16封装为数据帧发送至从站；从站接收后解析数据，将按键状态映射到指定GPIO端口控制外部设备，同时将模拟量转换为控制信号，并实时采集输入/输出端口状态，通过功能码04返回主站；主站根据反馈数据更新LED状态，实现双向实时交互。系统采用CRC-16校验和RS485差分传输确保抗干扰性，支持定时轮询和重发机制保障可靠性，并通过寄存器地址扩展实现灵活的功能拓展。

## 功能说明
### 主站（A站）功能说明
本主站基于STM32实现工业级数据交互控制，涵盖数据采集、通信控制、状态反馈、系统管理四大模块，以下是结构化功能说明：

一、数据采集功能
1. 多源信号采集
   - 按键扫描：通过TIM2定时器实现10ms级轮询扫描，捕捉机械按键状态变化（默认低电平，按键按下后转换为高电平）
   - 模拟量采集：
     - 双通道ADC采集：ADC1/ADC2同步采集0-5V电压信号（±0.1V精度）
     - 转换处理：12位分辨率模数转换，生成标准数字信号

二、通信功能
1. Modbus RTU主站协议栈
   - 帧结构生成：符合modbus RTU标准功能码16/04的请求帧构建
   - 定时轮询机制：每50ms向从站发送功能码16写入按键状态和ADC数值，完成后立即发送功能码04查询从站输入状态
    
2. 传输保障体系
   - RS485总线控制：PA11引脚驱动MAX485收发器方向切换（硬件防冲突设计）
   - 校验机制：CRC-16校验码生成与验证，错误帧自动丢弃
   - 重传策略：超时300ms未响应则重发，最大重试3次

3. 数据封装流程
   - 实时封装ADC数值与按键状态
   - 寄存器映射：
     - 寄存器0x1000：按键1-16的状态（每个位对应一个按键）
     - 寄存器0x1001：按键17-24的状态（低8位对应按键，高8位保留）
     - 寄存器0x1002：ADC1的值（12位分辨率）
     - 寄存器0x1003：ADC2的值（12位分辨率）
   - 帧字段：设备地址（1B）+功能码（1B）+数据域（N*2B）+CRC（2B）

三、状态显示功能
1. LED指示系统
   - 系统状态指示灯：PB12引脚控制单色LED（用于指示系统运行状态）
     - 常亮: 系统异常
     - 闪烁（间隔10ms）: 通信过程中/发送数据
     - 熄灭: 系统正常但无通信
   - 从站状态显示LED组：12个独立LED灯（LED1-LED12，位于PA0, PA3-PA7等端口）
     - 功能：显示从站输入端口的实时状态
     - 映射关系：每个LED对应从站的一个数字输入通道
     - 状态：亮=对应通道高电平，灭=对应通道低电平

### 从站（B站）功能（参考）
一、数据接收与处理功能
1. Modbus RTU从站协议栈
   - 帧接收：接收主站发送的Modbus RTU数据帧
   - 数据解析：解析功能码16写入的寄存器数据(按键状态和ADC数值)
   - 校验机制：CRC-16校验码验证，错误帧自动丢弃并返回异常码
   - 响应策略：接收到正确帧后立即响应，超时无响应

2. 数据处理流程
   - 数据存储：
     - 按键状态存储：保持寄存器0x1000-0x1001(0x1000存储按键1-16状态,0x1001存储按键17-24状态)
     - ADC数值存储：保持寄存器0x1002-0x1003(0x1002存储ADC0值,0x1003存储ADC1值)
     - 输入状态存储：输入寄存器0x2000(0x2000存储12路数字输入状态，每位对应一个输入通道)
   - 外设控制：
     - 数字输出：根据0x1000-0x1001寄存器数据实时控制OUTPUT1~OUTPUT24端口状态
     - 模拟输出：根据0x1002-0x1003寄存器数据实时更新DAC1/DAC2输出电压

二、控制输出功能
1. 数字输出控制
   - GPIO端口映射：24路数字输出(OUTPUT1~OUTPUT24)，分别连接到STM32的PB5-PB11、PD0-PD15、PE0引脚
   - 电气特性：每路输出最大电流25mA，3.3V TTL电平标准
   - 状态控制：根据主站发送的按键状态(寄存器0x1000-0x1001)实时控制对应端口电平
   - 响应时间：接收到主站数据后，输出端口状态更新时间<1ms
   - 安全机制：系统启动时所有输出默认为低电平，通信中断超过500ms自动将所有输出置为安全状态
   
2. 模拟输出控制
   - DAC信号输出：采用DAC7311芯片，2路独立DAC输出（DAC0/DAC1）
   - 通信接口：通过SPI方式控制DAC7311芯片
     * DAC0连接：
       - SCLK - PB13 (时钟信号)
       - DIN - PB14 (数据输入)
       - SYNC - PB15 (片选信号，低电平有效)
     * DAC1连接：
       - SCLK - PA1 (时钟信号)
       - DIN - PA2 (数据输入)
       - SYNC - PD2 (片选信号，低电平有效)
   - 数据传输：16位串行数据格式(4位控制位+12位数据位)
     * 控制字节：[X, X, PD1, PD0]
       - PD1,PD0=00: 正常工作模式
       - PD1,PD0=01: 1kΩ接地关断模式
       - PD1,PD0=10: 100kΩ接地关断模式
       - PD1,PD0=11: 高阻抗关断模式
     * 数据字节：12位有效数据(D11-D0)
   - 时序要求：
     * 最大时钟频率：30MHz
     * SYNC低电平持续时间：最小16ns
     * 数据建立时间：最小5ns
     * 数据保持时间：最小5ns
   - 输出特性：
     * 分辨率：12位(4096级)
     * 输出范围：0-VREF (3.3V)
     * 建立时间：8μs (满量程变化)
     * 精度：±0.1%满量程误差
     * 输出电流：±5mA
     * 参考电压：外部参考(本系统使用3.3V外部参考)
   - 参数调节：
     * 转换公式：VOUT = (ADC值/4095) × VREF
     * 映射关系：寄存器0x1002映射到DAC0，寄存器0x1003映射到DAC1
     * 数据格式：12位右对齐数据(0x000-0xFFF)
   - 更新频率：每次接收到主站新数据后立即更新，最快可达20ms更新一次
   - 滤波处理：输出端配置RC低通滤波电路(R=1kΩ，C=100nF)，截止频率约1.6kHz
   - 上电特性：
     * 上电复位：DAC输出默认为0V
     * 上电时间：约2.5μs
   - 功耗特性：
     * 正常工作模式：0.5mA (典型值)
     * 关断模式：0.2μA (典型值，高阻抗模式)

三、状态反馈功能
1. 数据采集系统
   - 输入采集：实时采集12路输入端口状态（INPUT1~INPUT12）
     * GPIO端口映射：12路数字输入(INPUT1~INPUT12)，分别连接到STM32的PA0、PA3-PA8、PA12、PA15、PC0-PC2引脚
   - 采集频率：每10ms采集一次所有端口状态
     * 采样方式：基于定时器中断的定时采样
     * 时间精度：采样周期误差<0.1ms
   - 数据处理：对输入信号进行去抖动处理，确保状态稳定性
     * 去抖算法：连续3次采样状态一致才认为状态有效变化
     * 滤波时间：有效识别最小脉宽为30ms的信
   - 状态存储：将采集到的状态存入对应寄存器，供主站读取
     * 寄存器映射：输入状态存储在寄存器0x2000-0x2001中
     * 位映射关系：每个位对应一个输入通道状态(0=低电平，1=高电平)

  
2. 数据反馈机制
   - 寄存器映射：12路输入状态存储在寄存器0x2000-0x2001中，每个位对应一个输入通道状态(0=低电平，1=高电平)
   - 响应封装：当主站通过功能码04(读输入寄存器)请求时，从站将当前输入状态数据打包返回
   - 状态更新：每10ms采集一次所有端口状态，经过去抖处理后更新到对应寄存器
   - 异常处理：当输入信号异常时，系统记录异常状态并通过异常响应码通知主站

### 系统特性
1. **可靠性设计**：
   - CRC-16校验确保数据完整性
   - RS485差分传输提高抗干扰能力
   - 通信超时检测和重发机制

2. **扩展性设计**：
   - 通过寄存器地址映射实现功能扩展
   - 预留接口支持更多外设连接
   - 模块化设计便于功能升级

3. **实时性能**：
   - 优化的通信时序设计
   - 高效的数据处理算法
   - 中断驱动的事件响应机制

## 硬件环境
- 芯片型号：STM32F103RCT6
- 外设清单：
  ### 主站
  #### 按键输入(24个机械按键)
  - KEY1(SW1) - PC3
  - KEY2(SW2) - PC4  
  - KEY3(SW3) - PC5
  - KEY4(SW4) - PC6
  - KEY5(SW5) - PC7
  - KEY6(SW6) - PC8
  - KEY7(SW7) - PC9
  - KEY8(SW8) - PC10
  - KEY9(SW9) - PC11
  - KEY10(SW10) - PC12
  - KEY11(SW11) - PC13
  - KEY12(SW12) - PC14
  - KEY13(SW13) - PC15
  - KEY14(SW14) - PB0
  - KEY15(SW15) - PB1
  - KEY16(SW16) - PB3
  - KEY17(SW17) - PB4
  - KEY18(SW18) - PB5
  - KEY19(SW19) - PB6
  - KEY20(SW20) - PB7
  - KEY21(SW21) - PB8
  - KEY22(SW22) - PB9
  - KEY23(SW23) - PB10
  - KEY24(SW24) - PB11

  #### LED指示灯(13个)
  - LED1 - PA0
  - LED2 - PA3
  - LED3 - PA4
  - LED4 - PA5
  - LED5 - PA6
  - LED6 - PA7
  - LED7 - PA8
  - LED8 - PA12
  - LED9 - PA15
  - LED10 - PC0
  - LED11 - PC1
  - LED12 - PC2
  - 系统状态LED - PB12

  #### 模拟量采集(2路ADC)
  - ADC0 - PA1
  - ADC1 - PA2

  #### 通信接口(USART1转RS485)
  - 芯片型号：MAX3485ESA+T
  - 引脚配置：
    - TX: PA9
    - RX: PA10
    - DE/RE: PA11 (方向控制，高电平发送/低电平接收)
  
  - 电气特性：
    - 工作电压：3.3V
    - 差分电压：>2V
    - 通信距离：最大1200米
    
  - 接线说明：
    - A+: 485差分信号正端
    - B-: 485差分信号负端
    - GND: 信号地
    - 终端电阻：120Ω (在总线两端)
    
  - 通信参数：
    - 波特率：115200
    - 数据位：8
    - 停止位：1
    - 校验位：无
    - 通信模式：半双工
    
  - 总线特性：
    - 支持多点通信
    - 抗干扰能力强
    - 传输距离远

## 寄存器映射建议
- 起始地址：0x1000
- 寄存器数量：4个（每个寄存器16位）
- 寄存器0x1000：按键1-16的状态（每个位对应一个按键）
- 寄存器0x1001：按键17-24的状态（低8位对应按键，高8位保留）
- 寄存器0x1002：ADC1的值（12位分辨率）
- 寄存器0x1003：ADC2的值（12位分辨率）

## 功能码的使用
每次通信分两个功能码，分别是：
1. 16功能码：负责向从站下发按键状态以及ADC状态参数，用来使从站根据接收到主站的数据驱动对应的数字输出接口以及模拟输出接口的状态
2. 04功能码：用来读取从站数字输入接口以及未来可能会扩展的模拟输入接口的状态，用来驱动主站上的LED显示状态以及未来有可能扩展的模拟量输出接口

## 3. 软件架构

### 3.1 代码实现过程

#### 系统初始化
- main.c中进行系统时钟配置和硬件初始化(GPIO、USART等)
- 调用bsp_init()函数初始化板级支持包,设置必要外设

#### MODBUS主站协议初始化  
- modbus_master.c中初始化MODBUS主站协议相关参数(波特率115200、无校验、8数据位、1停止位)
- 设置发送缓冲区和接收缓冲区用于与从站通信
- 配置从站地址和寄存器映射关系

#### 主循环逻辑
- main.c主循环中按照50ms固定周期访问从站设备
- 按照通信流程生成MODBUS请求命令:
  1. 发送功能码16写入命令:
     - 写入按键状态到从站寄存器0x1000-0x1001
     - 写入双通道ADC采样值到从站寄存器0x1002-0x1003
  2. 立即发送功能码04读取命令:
     - 读取从站数字输入接口状态（寄存器地址0x2000-0x2001）
     - 读取从站模拟输入接口状态(未来扩展)
- 通信保障机制:
  - 超时300ms未响应进行重发
  - 最多重试3次
  - 通过CRC-16校验确保数据正确性

#### 数据处理
- modbus_master.c中负责生成标准MODBUS请求帧
- 解析从站返回的响应数据,验证CRC校验
- 将有效数据更新到本地数据区：
  - 将从站寄存器0x2000的数据（数字输入状态）更新到主站本地数据区
  - 将从站寄存器0x2001-0x200F（如有）的扩展数据更新到对应本地数据区
- 将输入寄存器状态映射到LED指示灯（LED1-LED12）：
  - 将寄存器0x2000的12个低位（bit0-bit11）分别映射到LED1-LED12
  - 每个位为1时点亮对应LED，为0时熄灭对应LED
- 记录通信状态和错误信息,实现通信监控

#### LED状态显示
- 系统状态指示灯(PB12)显示工作状态:
  - 常亮: 系统异常
  - 闪烁: 数据通信进行中
  - 熄灭: 系统正常空闲状态


#### 中断处理
- stm32f4xx_it.c中处理USART1接收中断
- 接收从站响应数据并存入接收缓冲区
- 处理通信超时定时器中断

### 3.2 逻辑流程

1. 系统初始化阶段
   - 配置系统时钟和外设时钟
   - 初始化GPIO端口(按键输入、LED输出、RS485控制等)
   - 配置ADC采样参数(双通道、12位分辨率)
   - 初始化USART1(波特率115200、无校验、8数据位、1停止位)
   - 配置TIM2定时器用于10ms按键扫描
   - 设置Modbus主站参数(从站地址、寄存器映射等)

2. 数据采集处理
   - TIM2定时器中断每10ms扫描一次按键状态
   - ADC定时采样双通道模拟量(0-5V)
   - 将采样数据存入本地缓存区等待发送

3. Modbus通信处理(50ms周期)
   - 发送功能码16写入命令
     - 封装按键状态到寄存器0x1000-0x1001
     - 封装ADC数值到寄存器0x1002-0x1003
   - 发送功能码04读取命令
     - 读取从站数字输入接口状态（寄存器地址0x2000-0x2001）
     - 读取从站模拟输入接口状态（未来扩展）
   - 接收并解析从站响应数据
     - CRC校验确保数据正确性
     - 更新本地LED状态显示

4. 异常处理机制
   - 通信超时处理(300ms)
     - 重发机制(最多3次)
     - 更新通信状态标志
   - 数据校验错误
     - 丢弃错误数据帧
     - 记录错误类型和次数
   - LED状态指示
     - 常亮=系统异常
     - 闪烁=通信正常
     - 熄灭=从站离线

5. 循环执行
   - 持续进行从站数据发送以及数据采集采集
   - 维持稳定的主从通信

### 总结
这个MODBUS RTU主站程序实现了与单个从站的稳定通信。通过固定周期的数据写入以及数据采集,可以实时更新从站寄存器状态并获取从站输入接口状态，并更新主站LED1~LED12指示灯状态。系统采用RS485半双工通信,具有较强的抗干扰能力和远距离通信能力。通过LED指示灯实时反映工作状态,便于监控和维护。

## 开发计划

### 1. 环境搭建与基础配置 (第1周)
#### 1.1 开发环境准备
- [ ] 安装并配置Keil MDK开发环境
- [ ] 创建STM32F103RCT6项目工程
- [ ] 配置编译选项和调试设置

#### 1.2 系统架构设计
- [ ] 使用现有Core目录结构，不创建新文件夹
- [ ] 在Core目录中添加必要的源文件和头文件：
  ```
  Core
  ├── Inc                     # 头文件目录
  │   ├── main.h              # 主程序头文件
  │   ├── stm32f1xx_hal_conf.h # HAL库配置文件
  │   ├── stm32f1xx_it.h      # 中断处理函数头文件
  │   ├── bsp_adc.h           # ADC驱动头文件
  │   ├── bsp_key.h           # 按键驱动头文件
  │   ├── bsp_led.h           # LED驱动头文件
  │   ├── bsp_timer.h         # 定时器驱动头文件
  │   ├── bsp_usart.h         # 串口/RS485驱动头文件
  │   ├── modbus_rtu.h        # Modbus RTU基础协议头文件
  │   ├── modbus_master.h     # Modbus主站功能头文件
  │   ├── modbus_map.h        # 寄存器映射头文件
  │   ├── app_control.h       # 应用控制逻辑头文件
  │   ├── app_monitor.h       # 状态监控头文件
  │   └── app_debug.h         # 调试接口头文件
  │
  └── Src                     # 源文件目录
      ├── main.c              # 主程序源文件
      ├── stm32f1xx_it.c      # 中断处理函数源文件
      ├── bsp_adc.c           # ADC驱动源文件
      ├── bsp_key.c           # 按键驱动源文件
      ├── bsp_led.c           # LED驱动源文件
      ├── bsp_timer.c         # 定时器驱动源文件
      ├── bsp_usart.c         # 串口/RS485驱动源文件
      ├── modbus_rtu.c        # Modbus RTU基础协议源文件
      ├── modbus_master.c     # Modbus主站功能源文件
      ├── modbus_map.c        # 寄存器映射源文件
      ├── app_control.c       # 应用控制逻辑源文件
      ├── app_monitor.c       # 状态监控源文件
      └── app_debug.c         # 调试接口源文件
  ```
- [ ] 定义模块间接口规范
- [ ] 设计系统初始化流程

### 2. 硬件驱动层开发 (第2周)
#### 2.1 GPIO驱动模块
- [ ] 开发按键输入驱动 (bsp_key.c/h)
  - 初始化24个按键GPIO
  - 实现按键扫描函数
  - 实现按键状态读取接口
- [ ] 开发LED驱动 (bsp_led.c/h)
  - 初始化13个LED GPIO
  - 实现LED控制接口(开/关/翻转)
  - 实现LED状态指示模式(常亮/闪烁)

#### 2.2 ADC驱动模块 (bsp_adc.c/h)
- [ ] 配置ADC时钟和工作模式
- [ ] 实现双通道ADC初始化
- [ ] 开发ADC采样函数
- [ ] 实现数据滤波和校准算法

#### 2.3 USART/RS485驱动模块 (bsp_usart.c/h)
- [ ] 配置USART1参数(115200,8,N,1)
- [ ] 实现RS485方向控制(PA11)
- [ ] 开发数据发送/接收接口
- [ ] 实现接收中断处理

#### 2.4 定时器驱动模块 (bsp_timer.c/h)
- [ ] 配置TIM2用于按键扫描(10ms)
- [ ] 配置TIM3用于通信超时检测
- [ ] 实现定时器中断处理函数

### 3. 协议层开发 (第3周)
#### 3.1 Modbus RTU协议基础模块 (modbus_rtu.c/h)
- [ ] 实现CRC-16校验算法
- [ ] 开发Modbus帧解析函数
- [ ] 实现异常响应处理

#### 3.2 Modbus主站功能模块 (modbus_master.c/h)
- [ ] 实现功能码04(读输入寄存器)
- [ ] 实现功能码16(写多个寄存器)
- [ ] 开发请求帧构建函数
- [ ] 实现响应帧解析函数
- [ ] 开发超时重传机制

#### 3.3 数据映射模块 (modbus_map.c/h)
- [ ] 定义寄存器地址映射表
- [ ] 实现按键状态到寄存器的映射
- [ ] 实现ADC数值到寄存器的映射
- [ ] 开发从站状态到LED的映射

### 4. 应用层开发 (第4周)
#### 4.1 系统初始化模块 (main.c)
- [ ] 实现系统时钟配置
- [ ] 开发外设初始化流程
- [ ] 实现全局变量和状态定义

#### 4.2 主循环控制模块 (app_control.c/h)
- [ ] 实现50ms周期性通信控制
- [ ] 开发状态机管理
- [ ] 实现异常处理逻辑

#### 4.3 状态监控模块 (app_monitor.c/h)
- [ ] 开发系统状态监控函数
- [ ] 实现LED状态指示逻辑
- [ ] 开发通信状态记录功能

#### 4.4 调试接口模块 (app_debug.c/h)
- [ ] 实现调试信息输出
- [ ] 开发参数配置接口
- [ ] 实现运行状态查询功能

### 5. 系统集成与测试 (第5周)
#### 5.1 模块集成
- [ ] 集成驱动层和协议层
- [ ] 集成应用层和底层模块
- [ ] 解决模块间接口问题

#### 5.2 功能测试
- [ ] 测试按键输入功能
- [ ] 测试ADC采集功能
- [ ] 测试Modbus通信功能
- [ ] 测试LED指示功能

#### 5.3 系统测试
- [ ] 进行主从站通信测试
- [ ] 测试异常处理机制
- [ ] 进行长时间稳定性测试
- [ ] 测试边界条件和极限情况

#### 5.4 优化与完善
- [ ] 优化通信时序
- [ ] 提高系统响应速度
- [ ] 降低功耗
- [ ] 完善文档和注释

### 6. 文档编写与项目交付 (第6周)
#### 6.1 代码文档
- [ ] 完善代码注释
- [ ] 编写模块接口说明
- [ ] 整理函数调用关系图

#### 6.2 用户文档
- [ ] 编写系统使用说明
- [ ] 整理常见问题解答
- [ ] 编写故障排除指南

#### 6.3 项目总结
- [ ] 总结开发经验
- [ ] 分析系统性能
- [ ] 提出改进建议

## 开发进度
| 阶段 | 计划时间 | 实际时间 | 完成度 | 备注 |
|------|----------|----------|--------|------|
| 1. 环境搭建与基础配置 | 第1周 | - | 0% | - |
| 2. 硬件驱动层开发 | 第2周 | - | 0% | - |
| 3. 协议层开发 | 第3周 | - | 0% | - |
| 4. 应用层开发 | 第4周 | - | 0% | - |
| 5. 系统集成与测试 | 第5周 | - | 0% | - |
| 6. 文档编写与项目交付 | 第6周 | - | 0% | - |

## 注意事项
1. ADC配置建议：
   - 分辨率匹配：配置STM32的ADC为12位分辨率，与DAC7512的12位分辨率匹配
   - 采样率设置：建议采样率1kHz（每1ms采样一次），DAC7512建立时间约10μs，1ms的采样周期足够DAC稳定输出
   - 参考电压选择：建议使用3.3V作为ADC参考电压，这样ADC的满量程值与DAC7512的输出范围一致，简化数据转换

2. 按键状态采集方案：
   - 定时器扫描法：使用TIM2配置10ms中断，在中断服务程序中扫描所有按键状态
   - 按键状态存储：使用3个字节存储24个按键状态，每位对应一个按键状态
   - 按键状态压缩：将24个按键状态压缩到2个16位寄存器（寄存器0x1000存储按键1-16，寄存器0x1001存储按键17-24）

3. 数据处理流程：
   - 采集 → 滤波 → 缩放 → 打包 → 发送
   - 采集：通过ADC采集0-5V的模拟信号
   - 滤波：使用软件滤波（如移动平均）消除噪声
   - 缩放：将12位ADC值（0-4095）映射到DAC7512的输入范围
   - 打包：将数据封装到Modbus功能码16的数据帧中
   - 发送：通过RS485发送到从站 